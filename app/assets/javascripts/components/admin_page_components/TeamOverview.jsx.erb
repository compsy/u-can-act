class TeamOverview extends React.Component {
  constructor(props) {
    super(props);
    this.state = {
      Mentor: undefined,
      Student: undefined,
      groups: ['<%= Person::MENTOR %>', '<%= Person::STUDENT %>'],
      year: new Date().getFullYear(),
      week_number: undefined
    };
  }

  updateTeamDetails() {
    this.state.groups.forEach((x) => {
      this.loadTeamData(x);
    })
  }

  componentDidMount() {
    this.updateTeamDetails();
  }


  isDone() {
    return !this.state.result.protocol_completion.some((entry) => {
      return entry.future
    })
  }

  setHeader(xhr) {
    xhr.setRequestHeader('Authorization', 'Bearer ' + localStorage.getItem('id_token'));
  }

  loadTeamData(group) {
    var self = this

    // Only update if the subscription id has changed
    let year = '?year=' + this.state.year
    let week_number = this.state.week_number === undefined ? '' : '&week_number=' + this.state.week_number
    let percentage_threshold = '&percentage_threshold=70'

    let url = '/api/v1/admin/team/' + group + year + week_number + percentage_threshold

    $.ajax({
      url: url,
      type: 'GET',
      dataType: 'json',
      success: (response) => {
        self.setState({
          [group]: response
        })
      },
      error: function() {
        console.log('Error, call failed!');
      },
      beforeSend: self.setHeader
    });
  }

  handleYearChange(option) {
    this.setState({
      year: option
    })
    this.updateTeamDetails();
  }

  handleWeekChange(option) {
    this.setState({
      week_number: option
    })
    this.updateTeamDetails();
  }

  renderOverview() {
    return (
      <div className="container">
        <h3> Team overview </h3>
        <div className="col s12">
          <div className="col s4">
            <WeekDropdownMenu value={this.state.week_number} year={this.state.year} onChange={this.handleWeekChange.bind(this)}/>
          </div>
          <div className="col s8">
            <YearDropdownMenu value={this.state.year} onChange={this.handleYearChange.bind(this)}/>
          </div>
        </div>
        <div className="col s12">
          <div className="row">
            <div className="col s12">
              <TeamOverviewEntry overview={this.state.Mentor.overview} name='Mentors' />
              <TeamOverviewEntry overview={this.state.Student.overview} name='Students' />
            </div>
          </div>
        </div>
      </div>
    )
  }

  render() {
    var ready = true;
    this.state.groups.forEach((group) => {
      if (!this.state[group]) {
        ready = false;
      }
    })
    if (!ready) return (<div><div className="progress"><div className="indeterminate"></div></div></div>)

    return (
      <div>
        {this.renderOverview()}
      </div>
    )
  }
}
